<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaBot - AI Language Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .mic-button.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(29, 78, 216, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0);
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[95vh] max-h-[800px]">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-2xl">
            <h1 class="text-xl font-bold text-slate-800">LinguaBot</h1>
            <div id="status" class="text-right">
                <p class="text-sm font-medium text-slate-600" id="language-display">No Language</p>
                <p class="text-xs text-slate-400" id="goal-display">No Goal Selected</p>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area -->
        <div id="input-area" class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <button id="mic-button" class="mic-button p-4 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                </button>
                <p id="mic-helper" class="text-sm text-slate-500 flex-1">Press the mic to speak.</p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const chatContainer = document.getElementById('chat-container');
            const micButton = document.getElementById('mic-button');
            const micHelper = document.getElementById('mic-helper');
            const languageDisplay = document.getElementById('language-display');
            const goalDisplay = document.getElementById('goal-display');

            // --- App State ---
            let state = {
                currentLanguage: null,
                learningGoal: null,
                currentStage: 'welcome', // welcome, language_select, goal_select, level_select, mic_check, mic_check_retry, lesson_intro, lesson_practice
                userName: 'Rajesh', // Let's assume the user's name for the script
                isListening: false,
            };

            // --- Language-Specific Lesson Content ---
            const lessons = {
                'English': {
                    introPhrase: `"Hello, my name is..."`,
                    nativeComparison: 'In Hindi, this is like saying: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•á‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§π‡•à..."',
                    breakdown: [
                        '<b>Hello:</b> A common greeting.',
                        '<b>My:</b> Shows that something belongs to you (‡§Æ‡•á‡§∞‡§æ).',
                        '<b>Name:</b> Your name (‡§®‡§æ‡§Æ).',
                        '<b>Is:</b> The verb \'to be\' (‡§π‡•à).'
                    ],
                    practiceSentence: 'Hello, my name is Rajesh.',
                    recognitionLang: 'en-US'
                },
                'French': { introPhrase: `"Bonjour, je m'appelle..."`, nativeComparison: 'In English, this is like saying: "Hello, my name is..."', breakdown: [ '<b>Bonjour:</b> Hello.', '<b>Je:</b> I.', "<b>m'appelle:</b> call myself.", ], practiceSentence: "Bonjour, je m'appelle Rajesh.", recognitionLang: 'fr-FR' },
                'Spanish': { introPhrase: `"Hola, me llamo..."`, nativeComparison: 'In English, this is like saying: "Hello, my name is..."', breakdown: [ '<b>Hola:</b> Hello.', '<b>Me:</b> myself.', "<b>llamo:</b> I call.", ], practiceSentence: "Hola, me llamo Rajesh.", recognitionLang: 'es-ES' },
                'German': { introPhrase: `"Hallo, ich hei√üe..."`, nativeComparison: 'In English, this is like saying: "Hello, my name is..."', breakdown: [ '<b>Hallo:</b> Hello.', '<b>Ich:</b> I.', "<b>hei√üe:</b> am called.", ], practiceSentence: "Hallo, ich hei√üe Rajesh.", recognitionLang: 'de-DE' },
                'Mandarin': { introPhrase: `"‰Ω†Â•Ω, ÊàëÂè´..." (N«ê h«éo, w«í ji√†o...)"`, nativeComparison: 'In English, this is like saying: "Hello, my name is..."', breakdown: [ '<b>‰Ω†Â•Ω (N«ê h«éo):</b> Hello.', '<b>Êàë (w«í):</b> I.', "<b>Âè´ (ji√†o):</b> to be called.", ], practiceSentence: "N«ê h«éo, w«í ji√†o Rajesh.", recognitionLang: 'zh-CN' }
            };

            // --- Speech Recognition Setup ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.error("Speech Recognition not supported in this browser.");
                micButton.disabled = true;
                micHelper.textContent = "Speech recognition is not supported in your browser.";
            }
            
            // --- Bot Conversation Logic ---
            const conversationFlow = {
                welcome: { message: "Namaste! üôè Welcome to LinguaBot. I'm your personal AI tutor, here to help you master any language. To get started, what language would you like to learn?", options: ['English', 'French', 'Spanish', 'German', 'Mandarin'], nextStage: 'language_select' },
                language_select: (language) => ({ message: `Great choice! ${language} is a fantastic language for global communication. Now, let's personalize your learning path. Why are you learning ${language}?`, options: ['‚úàÔ∏è Travel', 'üíº Business & Career', '‚ù§Ô∏è Family & Friends', 'üß† Brain Training'], nextStage: 'goal_select' }),
                goal_select: (language) => ({ message: `Perfect. We'll focus on the professional communication skills you need to succeed. One last question: How would you describe your current level in ${language}?`, options: ["I'm a complete beginner", "I know a few words", "I can have a simple conversation"], nextStage: 'level_select' }),
                level_select: { message: "Great! Before we start your first lesson, let's do a quick microphone check to make sure everything is working correctly.", options: ["Check Microphone"], nextStage: 'mic_check' },
                mic_check: {
                    success: { message: "Excellent, your microphone is working perfectly! Let's begin your first lesson. Are you ready?", options: ["Yes, let's start!"], nextStage: 'lesson_intro' },
                    failure: { message: "It seems there was a problem with the microphone. Please check your browser permissions and network connection.", options: ["Try Mic Check Again"], nextStage: 'mic_check_retry' }
                },
                lesson_intro: (language) => {
                    const lesson = lessons[language] || lessons['English'];
                    return { message: `Let's learn a very important phrase: <b>${lesson.introPhrase}</b><br><br>${lesson.nativeComparison}<br><br>Let's break it down:<br>‚Ä¢ ${lesson.breakdown.join('<br>‚Ä¢ ')}<br><br>Now, it's your turn to practice. I want you to say the full phrase with your name at the end. For example, you would say, "<i>${lesson.practiceSentence}</i>"<br><br>Press the microphone button below and say the sentence.`, nextStage: 'lesson_practice' };
                },
                lesson_practice_feedback: (analysis) => {
                    let feedbackMessage = `Okay, great first attempt, ${state.userName}! Here is your detailed analysis:`;
                    if (analysis.overallScore > 90) feedbackMessage = `EXCELLENT! That was a huge improvement, ${state.userName}!`;
                    const message = `${feedbackMessage}<div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">${analysis.htmlReport}</div><br>Let's try again. Focus on the sounds for any highlighted words. You can do it!`;
                    addBotMessage(message);
                    state.currentStage = 'lesson_practice';
                    micButton.disabled = false;
                },
                lesson_complete: { message: `EXCELLENT! That was a perfect attempt!<br><br><b>You have successfully learned your first sentence in ${state.currentLanguage}!</b><br><br><b>Lesson 1 complete!</b> You learned:<br>‚Ä¢ How to introduce yourself.<br>‚Ä¢ Correct pronunciation.<br><br>We'll save your progress. Keep up the fantastic work!`, options: ["Continue to next lesson", "End Session for Today"], nextStage: 'end' }
            };

            // --- UI Functions ---
            const addBotMessage = (message, options = []) => {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'flex items-start gap-3 mb-6';
                botMessageDiv.innerHTML = `<div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">L</div><div class="bg-slate-200 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-xl"><p class="text-base">${message}</p></div>`;
                chatContainer.appendChild(botMessageDiv);

                if (options.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'flex flex-wrap gap-2 ml-12 mt-2';
                    options.forEach(optionText => {
                        const button = document.createElement('button');
                        button.className = 'px-4 py-2 bg-white border border-slate-300 rounded-full text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors';
                        button.textContent = optionText;
                        button.onclick = () => handleOptionClick(optionText, optionsDiv);
                        optionsDiv.appendChild(button);
                    });
                    chatContainer.appendChild(optionsDiv);
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };

            const addUserMessage = (message) => {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex items-start gap-3 mb-6 justify-end';
                userMessageDiv.innerHTML = `<div class="bg-blue-600 text-white p-4 rounded-lg rounded-br-none max-w-xl"><p class="text-base">"${message}"</p></div><div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-lg flex-shrink-0">${state.userName.charAt(0)}</div>`;
                chatContainer.appendChild(userMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };

            // --- Event Handlers & Logic ---
            const handleOptionClick = (optionText, optionsContainer) => {
                optionsContainer.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                addUserMessage(optionText);

                if (state.currentStage === 'mic_check' || state.currentStage === 'mic_check_retry') {
                    if (optionText.includes("Check Microphone") || optionText.includes("Try Mic Check Again")) {
                        state.currentStage = 'mic_check';
                        micHelper.textContent = "Click the mic button to start the check.";
                        micButton.disabled = false;
                        return;
                    }
                }
                
                setTimeout(() => advanceConversation(optionText), 500);
            };

            const advanceConversation = (userInput = null) => {
                micButton.disabled = true;
                let currentStep;
                switch (state.currentStage) {
                    case 'welcome': currentStep = conversationFlow.welcome; addBotMessage(currentStep.message, currentStep.options); state.currentStage = currentStep.nextStage; break;
                    case 'language_select': state.currentLanguage = userInput; languageDisplay.textContent = state.currentLanguage; currentStep = conversationFlow.language_select(userInput); addBotMessage(currentStep.message, currentStep.options); state.currentStage = currentStep.nextStage; break;
                    case 'goal_select': state.learningGoal = userInput.split(' ')[1]; goalDisplay.textContent = state.learningGoal; currentStep = conversationFlow.goal_select(state.currentLanguage); addBotMessage(currentStep.message, currentStep.options); state.currentStage = currentStep.nextStage; break;
                    case 'level_select': currentStep = conversationFlow.level_select; addBotMessage(currentStep.message, currentStep.options); state.currentStage = currentStep.nextStage; break;
                    case 'lesson_intro': if (recognition) { recognition.lang = lessons[state.currentLanguage]?.recognitionLang || 'en-US'; } currentStep = conversationFlow.lesson_intro(state.currentLanguage); addBotMessage(currentStep.message); state.currentStage = currentStep.nextStage; micButton.disabled = false; break;
                }
            };
            
            // --- Microphone Logic ---
            if (recognition) {
                micButton.addEventListener('click', () => {
                    if (state.isListening) {
                        recognition.stop();
                        return;
                    }
                    micButton.classList.add('listening');
                    micHelper.textContent = "Starting mic...";
                    micButton.disabled = true;
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        micHelper.textContent = "Could not start microphone. Please check permissions.";
                        micButton.classList.remove('listening');
                        micButton.disabled = false;
                    }
                });

                recognition.onstart = () => {
                    state.isListening = true;
                    micButton.disabled = false; // Allow user to click again to stop
                    micHelper.textContent = "Listening... Speak now!";
                };

                recognition.onend = () => {
                    state.isListening = false;
                    micButton.classList.remove('listening');
                    micHelper.textContent = "Press the mic to speak.";
                    // Re-enable button if we are in a stage that allows speaking
                    const canSpeak = state.currentStage === 'lesson_practice' || state.currentStage === 'mic_check' || state.currentStage === 'mic_check_retry';
                    micButton.disabled = !canSpeak;
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (state.currentStage === 'mic_check') {
                        addUserMessage(`(Mic Check) ${transcript}`);
                        const { success } = conversationFlow.mic_check;
                        addBotMessage(success.message, success.options);
                        state.currentStage = success.nextStage;
                        micButton.disabled = true;
                    } else {
                        addUserMessage(transcript);
                        micHelper.textContent = "Analyzing...";
                        setTimeout(() => processSpeech(transcript), 1000);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                    let errorMessage = "Sorry, an error occurred. Please try again.";
                    if (event.error === 'network') {
                        errorMessage = "Network error. Please check your connection and try again.";
                    } else if (event.error === 'no-speech') {
                        errorMessage = "I didn't hear you. Please press the mic and speak clearly.";
                    } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        errorMessage = "Mic access denied. Please allow microphone in your browser settings.";
                        micButton.disabled = true; // Permanently disable if permission is the core issue
                    }
                    
                    if (state.currentStage === 'mic_check') {
                        const { failure } = conversationFlow.mic_check;
                        addBotMessage(`${errorMessage}<br><br>${failure.message}`, failure.options);
                        state.currentStage = failure.nextStage;
                    } else {
                        micHelper.textContent = errorMessage;
                    }
                };
            }

            const processSpeech = (transcript) => {
                const analysis = simulateAnalysis(transcript);
                if (analysis.overallScore > 95) {
                    const completeStep = conversationFlow.lesson_complete;
                    addBotMessage(completeStep.message, completeStep.options);
                    state.currentStage = completeStep.nextStage;
                    micButton.disabled = true;
                } else {
                    conversationFlow.lesson_practice_feedback(analysis);
                }
            };

            // --- Analysis Simulation ---
            const simulateAnalysis = (text) => {
                if (state.currentLanguage !== 'English') {
                    return { overallScore: 100, htmlReport: `<h4 class="font-bold text-lg mb-2">Analysis Report</h4><p class="mb-4"><b>Your sentence:</b> "${text}"</p><div class="pl-4 border-l-4 border-green-400"><p class="font-semibold text-green-700">‚úÖ Great attempt! The analysis engine for ${state.currentLanguage} is still under development.</p></div>` };
                }
                
                let score = 100;
                let issues = [];
                const words = text.toLowerCase().split(' ');

                if (words.includes('mai')) { score -= 15; issues.push({ word: 'my', found: 'mai', fix: "The correct English sound is /ma…™/. Try opening your mouth wider, like when saying 'eye'." }); }
                if (words.includes('ij')) { score -= 15; issues.push({ word: 'is', found: 'ij', fix: "The 's' here should sound like a 'z'. Try to make a light buzzing sound: is-zzz." }); }
                if (words.includes('nem')) { score -= 10; issues.push({ word: 'name', found: 'nem', fix: "Ensure you pronounce the 'a' sound clearly, like in 'game'." }); }
                if (!words.includes('hello') || !words.includes('name') || !words.includes('is')) { score -= 30; issues.push({ word: 'Overall Structure', found: 'Missing words', fix: "The sentence seems incomplete. Make sure to include all the words: 'Hello, my name is...'" }); }
                
                let htmlReport = `<h4 class="font-bold text-lg mb-2">Analysis Report</h4><p class="mb-4"><b>Your sentence:</b> "${text}"</p><div class="space-y-3"><div><strong class="font-semibold">1. Pronunciation & Phonetics:</strong> <span class="font-bold ${score > 80 ? 'text-green-600' : 'text-amber-600'}">${score > 80 ? 'Excellent!' : 'Good Effort!'} (${Math.max(0, score)}% Accuracy)</span></div>`;
                if (issues.length > 0) {
                    issues.forEach(issue => { htmlReport += `<div class="pl-4 border-l-4 border-amber-400"><p class="font-semibold text-amber-700">‚ö†Ô∏è Slight Mispronunciation on <span class="font-bold">"${issue.word}"</span></p><p class="text-slate-600 text-sm">You pronounced it more like <span class="italic">"${issue.found}"</span>. ${issue.fix}</p></div>`; });
                } else {
                     htmlReport += `<div class="pl-4 border-l-4 border-green-400"><p class="font-semibold text-green-700">‚úÖ Perfect pronunciation on all words!</p></div>`;
                }
                htmlReport += `<div class="pt-2"><strong class="font-semibold">2. Grammar & Syntax:</strong> <span class="font-bold text-green-600">Perfect!</span></div><div class="pl-4 border-l-4 border-green-400"><p class="text-slate-600 text-sm">You used the correct sentence structure. Great job!</p></div></div>`;
                return { overallScore: Math.max(0, score), htmlReport: htmlReport };
            };

            // --- Initial Kick-off ---
            setTimeout(() => advanceConversation(), 500);
        });
    </script>
</body>
</html>
