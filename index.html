<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinguaBot - AI Language Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .mic-button.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(29, 78, 216, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(29, 78, 216, 0);
            }
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[95vh] max-h-[800px]">
        
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-2xl">
            <div>
                <h1 class="text-xl font-bold text-slate-800">LinguaBot</h1>
                <p id="progress-display" class="text-xs text-blue-600 font-semibold mt-1">Loading progress...</p>
            </div>
            <div id="status" class="text-right">
                <p class="text-sm font-medium text-slate-600" id="language-display">No Language</p>
                <p class="text-xs text-slate-400" id="goal-display">No Goal Selected</p>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input Area -->
        <div id="input-area" class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <button id="mic-button" class="mic-button p-4 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                </button>
                <p id="mic-helper" class="text-sm text-slate-500 flex-1">Press the mic to speak.</p>
            </div>
        </div>

    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- DOM Elements ---
            const chatContainer = document.getElementById('chat-container');
            const micButton = document.getElementById('mic-button');
            const micHelper = document.getElementById('mic-helper');
            const languageDisplay = document.getElementById('language-display');
            const goalDisplay = document.getElementById('goal-display');
            const progressDisplay = document.getElementById('progress-display');

            // --- App State ---
            let state = {
                currentLanguage: null,
                learningGoal: null,
                currentLesson: 1,
                completedLessons: 0,
                currentStage: 'loading',
                userName: 'User',
                isListening: false,
                userId: null,
                micChecked: false,
            };
            
            // --- Firebase Setup ---
            let db, auth;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'lingua-bot-app';
            
            async function initFirebase() {
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            state.userId = user.uid;
                            await loadUserData();
                        } else {
                            // If no user, sign in.
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    progressDisplay.textContent = "Error: Could not connect to service.";
                }
            }

            // --- Firestore Data Functions ---
            const getUserDocRef = () => {
                if (!state.userId) return null;
                return doc(db, "artifacts", appId, "users", state.userId, "progress", "main");
            };

            async function saveUserData() {
                if (!state.userId) return;
                const userDocRef = getUserDocRef();
                const dataToSave = {
                    currentLanguage: state.currentLanguage,
                    learningGoal: state.learningGoal,
                    completedLessons: state.completedLessons,
                    micChecked: state.micChecked,
                };
                try {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                } catch (error) {
                    console.error("Error saving user data:", error);
                }
            }

            async function loadUserData() {
                if (!state.userId) return;
                const userDocRef = getUserDocRef();
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        state.currentLanguage = data.currentLanguage || null;
                        state.learningGoal = data.learningGoal || null;
                        state.completedLessons = data.completedLessons || 0;
                        state.micChecked = data.micChecked || false;
                        state.currentLesson = state.completedLessons + 1;
                        
                        updateUIFromState();

                        if (state.currentLanguage) {
                            addBotMessage(`Welcome back! Let's continue learning ${state.currentLanguage}.`);
                            startLesson(state.currentLesson);
                        } else {
                            advanceConversation('start_welcome');
                        }
                    } else {
                        // New user
                        advanceConversation('start_welcome');
                    }
                } catch (error) {
                    console.error("Error loading user data:", error);
                    advanceConversation('start_welcome');
                }
            }
            
            function updateUIFromState() {
                if(state.currentLanguage) languageDisplay.textContent = state.currentLanguage;
                if(state.learningGoal) goalDisplay.textContent = state.learningGoal;
                progressDisplay.textContent = `Progress: Lesson ${state.currentLesson}`;
            }

            // --- Language-Specific Lesson Content ---
            const lessons = {
                'English': [
                    null, // index 0 is unused
                    { title: "Introduction", introPhrase: `"Hello, my name is..."`, nativeComparison: 'In Hindi, this is like saying: "नमस्ते, मेरा नाम है..."', breakdown: [ '<b>Hello:</b> A common greeting.', '<b>My:</b> Shows that something belongs to you (मेरा).', '<b>Name:</b> Your name (नाम).', '<b>Is:</b> The verb \'to be\' (है).' ], practiceSentence: 'Hello, my name is Rajesh.', recognitionLang: 'en-US' },
                    { title: "Asking Names", introPhrase: `"What is your name?"`, nativeComparison: 'In Hindi: "आपका नाम क्या है?"', breakdown: [ '<b>What:</b> A question word.', '<b>is your:</b> Asks about something belonging to the other person.', '<b>name:</b> (नाम).', ], practiceSentence: 'What is your name?', recognitionLang: 'en-US' }
                ],
                // Add more lessons for other languages here
            };

            // --- Speech Recognition Setup ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
            } else {
                console.error("Speech Recognition not supported in this browser.");
                micButton.disabled = true;
                micHelper.textContent = "Speech recognition is not supported.";
            }
            
            // --- Bot Conversation Logic ---
            const conversationFlow = {
                welcome: { message: "Namaste! 🙏 Welcome to LinguaBot. I'm your personal AI tutor. To get started, what language would you like to learn?", options: ['English', 'French', 'Spanish', 'German', 'Mandarin'], nextStage: 'language_select' },
                language_select: (language) => ({ message: `Great choice! ${language} is a fantastic language. Now, let's personalize your learning path. Why are you learning ${language}?`, options: ['✈️ Travel', '💼 Business & Career', '❤️ Family & Friends', '🧠 Brain Training'], nextStage: 'goal_select' }),
                goal_select: (language) => ({ message: `Perfect. We'll focus on professional skills. One last question: How would you describe your current level in ${language}?`, options: ["I'm a complete beginner"], nextStage: 'level_select' }),
                level_select: { message: "Great! Before we start, let's do a quick microphone check.", options: ["Check Microphone"], nextStage: 'mic_check' },
                mic_check: {
                    success: { message: "Excellent, your microphone is working perfectly! Let's begin your first lesson. Are you ready?", options: ["Yes, let's start!"], nextStage: 'start_lesson_1' },
                    failure: { message: "It seems there was a problem. Please check your browser permissions and network connection.", options: ["Try Mic Check Again"], nextStage: 'mic_check_retry' }
                },
                lesson_complete: { message: `EXCELLENT! That was a perfect attempt! Lesson complete!`, options: ["Continue to next lesson"], nextStage: 'start_next_lesson' }
            };

            // --- UI Functions ---
            const addBotMessage = (message, options = []) => {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'flex items-start gap-3 mb-6';
                botMessageDiv.innerHTML = `<div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">L</div><div class="bg-slate-200 text-slate-800 p-4 rounded-lg rounded-tl-none max-w-xl"><p class="text-base">${message}</p></div>`;
                chatContainer.appendChild(botMessageDiv);

                if (options.length > 0) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'flex flex-wrap gap-2 ml-12 mt-2';
                    options.forEach(optionText => {
                        const button = document.createElement('button');
                        button.className = 'px-4 py-2 bg-white border border-slate-300 rounded-full text-sm font-medium text-slate-700 hover:bg-slate-100 transition-colors';
                        button.textContent = optionText;
                        button.onclick = () => handleOptionClick(optionText, optionsDiv);
                        optionsDiv.appendChild(button);
                    });
                    chatContainer.appendChild(optionsDiv);
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };

            const addUserMessage = (message) => {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex items-start gap-3 mb-6 justify-end';
                userMessageDiv.innerHTML = `<div class="bg-blue-600 text-white p-4 rounded-lg rounded-br-none max-w-xl"><p class="text-base">"${message}"</p></div><div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center text-slate-600 font-bold text-lg flex-shrink-0">${state.userName.charAt(0)}</div>`;
                chatContainer.appendChild(userMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };

            // --- Event Handlers & Logic ---
            const handleOptionClick = (optionText, optionsContainer) => {
                optionsContainer.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                addUserMessage(optionText);

                if (state.currentStage === 'mic_check' || state.currentStage === 'mic_check_retry') {
                    if (optionText.includes("Check Microphone") || optionText.includes("Try Mic Check Again")) {
                        state.currentStage = 'mic_check';
                        micHelper.textContent = "Click the mic button to start the check.";
                        micButton.disabled = false;
                        return;
                    }
                }
                
                setTimeout(() => advanceConversation(optionText), 500);
            };

            function startLesson(lessonNumber) {
                const langLessons = lessons[state.currentLanguage];
                if (langLessons && langLessons[lessonNumber]) {
                    const lesson = langLessons[lessonNumber];
                    state.currentLesson = lessonNumber;
                    updateUIFromState();
                    const message = `<b>Lesson ${lessonNumber}: ${lesson.title}</b><br><br>Let's learn the phrase: <b>${lesson.introPhrase}</b><br><br>${lesson.nativeComparison}<br><br>Let's break it down:<br>• ${lesson.breakdown.join('<br>• ')}<br><br>Now, it's your turn to practice. Say, "<i>${lesson.practiceSentence}</i>"<br><br>Press the microphone button below.`;
                    addBotMessage(message);
                    state.currentStage = 'lesson_practice';
                    if(recognition) recognition.lang = lesson.recognitionLang;
                    micButton.disabled = false;
                } else {
                    addBotMessage("Congratulations! You've completed all available lessons for this language. Check back later for more!");
                    micButton.disabled = true;
                }
            }

            const advanceConversation = (userInput = null) => {
                micButton.disabled = true;
                let currentStep;

                const stage = state.currentStage;

                if (userInput === 'start_welcome') {
                    currentStep = conversationFlow.welcome;
                    addBotMessage(currentStep.message, currentStep.options);
                    state.currentStage = currentStep.nextStage;
                    return;
                }

                switch (stage) {
                    case 'language_select':
                        state.currentLanguage = userInput;
                        saveUserData();
                        updateUIFromState();
                        currentStep = conversationFlow.language_select(userInput);
                        addBotMessage(currentStep.message, currentStep.options);
                        state.currentStage = currentStep.nextStage;
                        break;
                    case 'goal_select':
                        state.learningGoal = userInput.split(' ')[1];
                        saveUserData();
                        updateUIFromState();
                        currentStep = conversationFlow.goal_select(state.currentLanguage);
                        addBotMessage(currentStep.message, currentStep.options);
                        state.currentStage = currentStep.nextStage;
                        break;
                    case 'level_select':
                        if (state.micChecked) {
                            startLesson(1);
                        } else {
                            currentStep = conversationFlow.level_select;
                            addBotMessage(currentStep.message, currentStep.options);
                            state.currentStage = currentStep.nextStage;
                        }
                        break;
                    case 'start_lesson_1':
                        startLesson(1);
                        break;
                    case 'start_next_lesson':
                        state.completedLessons = state.currentLesson;
                        state.currentLesson++;
                        saveUserData();
                        startLesson(state.currentLesson);
                        break;
                }
            };
            
            // --- Microphone Logic ---
            if (recognition) {
                micButton.addEventListener('click', () => {
                    if (state.isListening) { recognition.stop(); return; }
                    micButton.classList.add('listening');
                    micHelper.textContent = "Starting mic...";
                    micButton.disabled = true;
                    try { recognition.start(); } catch (e) { console.error("Error starting recognition:", e); micHelper.textContent = "Could not start mic."; micButton.classList.remove('listening'); micButton.disabled = false; }
                });

                recognition.onstart = () => { state.isListening = true; micButton.disabled = false; micHelper.textContent = "Listening... Speak now!"; };
                recognition.onend = () => { state.isListening = false; micButton.classList.remove('listening'); micHelper.textContent = "Press the mic to speak."; const canSpeak = state.currentStage === 'lesson_practice' || state.currentStage === 'mic_check' || state.currentStage === 'mic_check_retry'; micButton.disabled = !canSpeak; };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (state.currentStage === 'mic_check') {
                        addUserMessage(`(Mic Check) ${transcript}`);
                        state.micChecked = true;
                        saveUserData();
                        const { success } = conversationFlow.mic_check;
                        addBotMessage(success.message, success.options);
                        state.currentStage = 'start_lesson_1';
                        micButton.disabled = true;
                    } else {
                        addUserMessage(transcript);
                        micHelper.textContent = "Analyzing...";
                        setTimeout(() => processSpeech(transcript), 1000);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                    let errorMessage = "Sorry, an error occurred.";
                    if (event.error === 'network') errorMessage = "Network error. Check your connection.";
                    else if (event.error === 'no-speech') errorMessage = "I didn't hear you. Please speak clearly.";
                    else if (event.error === 'not-allowed') { errorMessage = "Mic access denied."; micButton.disabled = true; }
                    
                    if (state.currentStage === 'mic_check') {
                        const { failure } = conversationFlow.mic_check;
                        addBotMessage(`${errorMessage}<br><br>${failure.message}`, failure.options);
                        state.currentStage = failure.nextStage;
                    } else { micHelper.textContent = errorMessage; }
                };
            }

            const processSpeech = (transcript) => {
                const analysis = simulateAnalysis(transcript);
                if (analysis.overallScore > 95) {
                    const completeStep = conversationFlow.lesson_complete;
                    addBotMessage(completeStep.message, completeStep.options);
                    state.currentStage = completeStep.nextStage;
                    micButton.disabled = true;
                } else {
                    const feedbackMessage = `Okay, great attempt! Here is your analysis:<div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">${analysis.htmlReport}</div><br>Let's try again. You can do it!`;
                    addBotMessage(feedbackMessage);
                    state.currentStage = 'lesson_practice';
                    micButton.disabled = false;
                }
            };

            // --- Analysis Simulation ---
            const simulateAnalysis = (text) => {
                if (state.currentLanguage !== 'English') { return { overallScore: 100, htmlReport: `<h4 class="font-bold text-lg mb-2">Analysis Report</h4><p class="mb-4"><b>Your sentence:</b> "${text}"</p><div class="pl-4 border-l-4 border-green-400"><p class="font-semibold text-green-700">✅ Great attempt! Analysis for ${state.currentLanguage} is developing.</p></div>` }; }
                let score = 100;
                let issues = [];
                const words = text.toLowerCase().split(' ');
                if (words.includes('mai')) { score -= 15; issues.push({ word: 'my', found: 'mai', fix: "The correct English sound is /maɪ/. Try opening your mouth wider, like when saying 'eye'." }); }
                if (words.includes('ij')) { score -= 15; issues.push({ word: 'is', found: 'ij', fix: "The 's' here should sound like a 'z'. Try to make a light buzzing sound: is-zzz." }); }
                if (!words.includes('hello') || !words.includes('name') || !words.includes('is')) { score -= 30; issues.push({ word: 'Overall Structure', found: 'Missing words', fix: "The sentence seems incomplete. Make sure to include all the words." }); }
                let htmlReport = `<h4 class="font-bold text-lg mb-2">Analysis Report</h4><p class="mb-4"><b>Your sentence:</b> "${text}"</p><div class="space-y-3"><div><strong class="font-semibold">1. Pronunciation:</strong> <span class="font-bold ${score > 80 ? 'text-green-600' : 'text-amber-600'}">${score > 80 ? 'Excellent!' : 'Good Effort!'} (${Math.max(0, score)}% Accuracy)</span></div>`;
                if (issues.length > 0) { issues.forEach(issue => { htmlReport += `<div class="pl-4 border-l-4 border-amber-400"><p class="font-semibold text-amber-700">⚠️ Mispronunciation on <span class="font-bold">"${issue.word}"</span></p><p class="text-slate-600 text-sm">You said <span class="italic">"${issue.found}"</span>. ${issue.fix}</p></div>`; }); } 
                else { htmlReport += `<div class="pl-4 border-l-4 border-green-400"><p class="font-semibold text-green-700">✅ Perfect pronunciation on all words!</p></div>`; }
                htmlReport += `<div class="pt-2"><strong class="font-semibold">2. Grammar:</strong> <span class="font-bold text-green-600">Perfect!</span></div></div>`;
                return { overallScore: Math.max(0, score), htmlReport: htmlReport };
            };

            // --- Initial Kick-off ---
            await initFirebase();
        });
    </script>
</body>
</html>
